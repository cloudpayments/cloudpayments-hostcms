# cloudpayments-hostcms
Модуль оплаты Сloudpayments для HostCMS 6.x+

Инструкция по установке:

В меню «**Контент**» => «**Интернет-магазины**» выбираем магазин к которому необходимо подключить модуль. В верхнем горизонтальном меню переходим в раздел «**Справочники**» =-> «**Платежные системы**». В меню «Платежная система» выбираем пункт «**Добавить**». В поле «**Название**» вписываем название платежной системы «**Оплата картами Visa, MasterCard, МИР (CloudPayments)**», поле «**Описание**» заполняем произвольно, далее нажимаем кнопку «**Применить**».

![Скрин 1](http://i.imgur.com/xkS9oS4.png)

Находясь в меню «**Справочник платежных систем**» напротив пункта «**Оплата картами Visa, MasterCard, МИР (CloudPayments)**» необходимо нажать кнопку «**Редактировать**» (карандашик). В окне редактирования информации о платежной системе, во вкладке «**Дополнительные**» — запоминаем значение свойства «**Идентификатор**» (*например, 50*).

Переходим в окно редактирования информации о платежной (**вкладка «Основные»**). Поставьте галочку напротив пункта «**Активность**». В поле «Обработчик» нужно скопировать код из файла cp_payhandle.php (https://github.com/cloudpayments/cloudpayments-hostcms/blob/master/cp_payhandle.php).

Далее необходимо выполнить следующее:

а) в строке «**class Shop_Payment_System_HandlerXX extends Shop_Payment_System_Handler**» вместо символов XX необходимо указать идентификатор (из вкладки «**Дополнительные**»). В результате получится подобная строка: «**class Shop_Payment_System_Handler27 extends Shop_Payment_System_Handler**»;

б) указать свои данные в указанном ниже конфигурационном блоке кода:
```php
/* Блок настроек модуля оплаты CloudPayments */
    // Данные продавца из личного кабинета
    private $_cp_public_id = '<ЗАПОЛНИТЕ ЭТИ ДАННЫЕ>'; // Public ID сайта
    private $_cp_api_pass = '<ЗАПОЛНИТЕ ЭТИ ДАННЫЕ>'; // Пароль для API сайта
    private $_cp_default_currency = "RUB"; // Валюта платежей
    
    // Блок настроек онлайн-кассы (ФЗ-54), подробная информация на https://cloudpayments.ru/docs/api/kassa
    private $_cp_onlinekassa_enabled = false; // Включить отправку чеков (true - да, false - нет)
    
    private $_cp_onlinekassa_taxtype = 10; /* null - НДС не облагается, 0 - НДС 0%, 10 - НДС 10%, 20 - НДС 20%,  
                                            * 110 — расчетный НДС 10/110, 120 — расчетный НДС 20/120 */
    
    private $_cp_onlinekassa_taxsystem = 0; /* 0 — Общая система налогообложения
                                                1 — Упрощенная система налогообложения (Доход)
                                                2 — Упрощенная система налогообложения (Доход минус Расход)
                                                3 — Единый налог на вмененный доход
                                                4 — Единый сельскохозяйственный налог
                                                5 — Патентная система налогообложения */
    /* Конец блока настроек модуля оплаты CloudPayments */
```

![Скрин 2](http://i.imgur.com/yQAInMa.png)
    
в) нажать кнопку «**Применить**». Окно «**Справочник платежных систем**» теперь можно закрыть;
    
г) зайти в меню «**Структура сайта**» => «**Типовые динамические страницы**» и открываем папку «**Интернет-магазин**». Далее нажимаем кнопку «**Редактировать**» (карандашик) напротив пункта «**Интернет-магазин корзина**». В открывшемся окне редактирования типовой динамической страницы переходим на вкладку «**Настройки страницы**». В поле «**Настройки типовой динамической страницы**» (перед строкой «**// Добавление товара в корзину**») необходимо вставить следующий код обработчика платежей (https://github.com/cloudpayments/cloudpayments-hostcms/blob/master/cp_carthandle.php):
```php
    // Обработка оплаты Cloudpayments
    if(isset($_POST["TransactionId"])) {
      $order_id = intval($_POST["InvoiceId"]);	
      $oShop_Order = Core_Entity::factory("Shop_Order")->find($order_id);
      if (!is_null($oShop_Order->id)) {
        // Вызов обработчика платежной системы
        Shop_Payment_System_Handler::factory($oShop_Order->Shop_Payment_System)
        ->shopOrder($oShop_Order)
        ->paymentProcessing();
        exit();    
        }
    }
```

![Скрин 3](http://i.imgur.com/w0vAZxI.png)

д) необходимо нажать кнопку «**Применить**». Окно «Список типовых динамических страниц» теперь можно закрыть, настройка модуля завершена;

е) в личном кабинете CloudPayments необходимо указать адрес для отправки уведомлений как - "**http://<адрес сайта.ru>/shop/cart/**".

![Скрин 4](https://imgur.com/jlAZuur)
